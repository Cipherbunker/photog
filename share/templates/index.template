<!doctype html>
<html>
  <head>
    <title>[% website_title %]</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="[% static('main.css') %]" />
    <link rel="stylesheet" href="[% static('magnific-popup.css') %]">
  </head>
  <body>
    <div id="header">
      <h1><a href="/" id="logo">[% website title %]</a></h1>
    </div>

    <div id="gallery">
    [% FOREACH item in items %]
    [% IF item.type == image %]
      <a title="Click image to enlarge" href="[% image.href %]" class="photolink"><img alt="[% image.title %]" data-settings="[% image.settings %]" data-width="[% image.width %]" data-height="[% image.height %]" src="[% image.src %]" /></a>
    [% ELSIF item.type == gallery %]
      <a title="Click to visit gallery" href="[% image.href %]"><img alt="[% image.title %]" data-width="[% image.width %]" data-height="[% image.height %]" src="[% image.src %]" /></a>
    [% END %]
    </div>

    <script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
    <script src="[% static('jquery.magnific-popup.js') %]"></script> 
    <script>

/* Derived from
 * http://blog.vjeux.com/2012/image/image-layout-algorithm-google-plus.html
 */

HEIGHTS = [];

function getheight(images, width) {
  width -= images.length * 5;
  var h = 0;
  for (var i = 0; i < images.length; ++i) {
    h += $(images[i]).data('width') / $(images[i]).data('height');
  }
  return width / h;
}

function setheight(images, height) {
  HEIGHTS.push(height);
  for (var i = 0; i < images.length; ++i) {
    $(images[i]).css({
      width: height * $(images[i]).data('width') /
$(images[i]).data('height'),
      height: height
    });
    $(images[i]).attr('src',
    $(images[i]).attr('src').replace(/w[0-9]+-h[0-9]+/, 'w' +
    $(images[i]).width() + '-h' + $(images[i]).height()));
  }
}

function resize(images, width) {
  setheight(images, getheight(images, width));
}

function run(max_height) {
  var size = $('#gallery').width() - 25;
  console.log(size);

  var n = 0;
  var images = $('#gallery img');
  w: while (images.length > 0) {
    for (var i = 1; i < images.length + 1; ++i) {
      var slice = images.slice(0, i);
      var h = getheight(slice, size);
      if (h < max_height) {
        setheight(slice, h);
        n++;
        images = images.slice(i);
        continue w;
      }
    }
    setheight(slice, Math.min(max_height, h));
    n++;
    break;
  }
}

window.addEventListener('resize', function () { run(366); });

function imageTitle(obj) {
    var img = obj.el.children('img');
    var title = img.attr('alt');
    var settings = img.attr('data-settings');
    return '<b>' + title + '</b>' + '&nbsp; <form target="_blank" id="settingsform" method="POST" style="display:inline" action="http://exifdata.com/exif.php"><input type="hidden" name="picurl" value="' + window.location + obj.src + '"><span class="settings">(<a href="#" title="Click to show all metadata" onclick="document.getElementById(\'settingsform\').submit(); event.preventDefault(); event.stopPropagation()">' + settings + '</a> &middot; <a title="Click to download full-size image" href="' + obj.src + '" target="_blank" onclick="event.stopPropagation()">download full size</a>)</span></form>';
}

$(function() {
    run(366);

    $('#gallery').magnificPopup({
        delegate: 'a.photolink',
        closeOnContentClick: true,
        showCloseBtn: false,
        type: 'image',
        gallery: {
            enabled: true,
            preload: [1,3],
            navigateByImgClick: false,
            tCounter: ''
        },

        image: {
            titleSrc: imageTitle,
            cursor: 'justregularplease',
        },
        mainClass: 'mfp-with-zoom',
        zoom: {
            enabled: true,
            duration: 300,
            easing: 'ease-in-out',
            opener: function(openerElement) {
                return openerElement.is('img') ? openerElement : openerElement.find('img');
            }
        }
    });
});

    </script>

  </body>
</html>
